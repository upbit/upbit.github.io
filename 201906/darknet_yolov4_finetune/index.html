<!doctype html><html lang=zh-cn><head><title>训练 Darknet YOLOv4/YOLOv3-tiny 进行自定义物体识别 // 夢沉抹大拉</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.104.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Zhou Hao"><meta name=description content="Training Darknet YOLOv4/YOLOv3-tiny to detect custom objects"><link rel=stylesheet href=https://blog.imaou.com/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css><meta name=twitter:card content="summary"><meta name=twitter:title content="训练 Darknet YOLOv4/YOLOv3-tiny 进行自定义物体识别"><meta name=twitter:description content="Training Darknet YOLOv4/YOLOv3-tiny to detect custom objects"><meta property="og:title" content="训练 Darknet YOLOv4/YOLOv3-tiny 进行自定义物体识别"><meta property="og:description" content="Training Darknet YOLOv4/YOLOv3-tiny to detect custom objects"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.imaou.com/201906/darknet_yolov4_finetune/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-06-14T20:00:00+08:00"><meta property="article:modified_time" content="2019-06-14T20:00:00+08:00"></head><body><header class=app-header><a href=https://blog.imaou.com><img class=app-header-avatar src=/avatar.jpg alt="Zhou Hao"></a>
<span class=app-header-title>夢沉抹大拉</span><nav class=app-header-menu><a class=app-header-menu-item href=/>Blog</a>
/
<a class=app-header-menu-item href=/page/about/>About</a></nav><p>一个追寻抹大拉之地的geeker</p><div class=app-header-social><a href=https://github.com/upbit target=_blank rel="noreferrer noopener me"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>GitHub</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://upbit.artstation.com/ target=_blank rel="noreferrer noopener me"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-aperture"><title>ArtStation</title><circle cx="12" cy="12" r="10"/><line x1="14.31" y1="8" x2="20.05" y2="17.94"/><line x1="9.69" y1="8" x2="21.17" y2="8"/><line x1="7.38" y1="12" x2="13.12" y2="2.06"/><line x1="9.69" y1="16" x2="3.95" y2="6.06"/><line x1="14.31" y1="16" x2="2.83" y2="16"/><line x1="16.62" y1="12" x2="10.88" y2="21.94"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>训练 Darknet YOLOv4/YOLOv3-tiny 进行自定义物体识别</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jun 14, 2019</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div></div></header><div class=post-content><blockquote><p>最近机缘巧合下接触到智慧零售，于是了解到一些基于摄像头的流量（人/车）监控方案。其基本思路，基本都是通过SSD或者YOLO识别具体人物，然后计算帧与帧中物体经过gate的个数&mldr; 所以第一步先来搞定物体识别。</p></blockquote><p>先附上colab notebook，不想看介绍的可以直接看演示：</p><ul><li>YOLOv3-tiny: <a href="https://colab.research.google.com/drive/1XSArXZImsYsorzcv4vX3aN5TQaLkKmPx?usp=sharing">https://colab.research.google.com/drive/1XSArXZImsYsorzcv4vX3aN5TQaLkKmPx?usp=sharing</a></li><li>YOLOv4<code>训练较慢，GPU大概要半小时才100次迭代</code>: <a href="https://colab.research.google.com/drive/1XIpuhhTlVvYIDzenZxdWKl-tk7lwbL-2?usp=sharing">https://colab.research.google.com/drive/1XIpuhhTlVvYIDzenZxdWKl-tk7lwbL-2?usp=sharing</a></li></ul><h2 id=1-alexeyabdarknethttpsgithubcomalexeyabdarknet>1. <a href=https://github.com/AlexeyAB/darknet>AlexeyAB/darknet</a></h2><p>看了下，darknet应该是目前最好上手的项目，编译就是个bin文件，加载模型和<code>training</code>(fine-tune)都是用这个工具完成。因为要用到最新的 YOLOv4，所以选alexeyab的版本。</p><h3 id=11-编译-make-darknet>1.1 编译 (make darknet)</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># clone 并编译darknet</span>
</span></span><span style=display:flex><span>!test -d darknet <span style=color:#f92672>||</span> git clone https://github.com/AlexeyAB/darknet
</span></span><span style=display:flex><span>%cd darknet
</span></span><span style=display:flex><span>!make -j8
</span></span></code></pre></div><h3 id=12-预测-detect>1.2 预测 (detect)</h3><p>先下载预训练的权重：yolov3-tiny-prn.weights，放在当前目录下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 准备预测用图片，这里我们用一张高速的照片</span>
</span></span><span style=display:flex><span>!wget https://github.com/nathanrooy/rpi-urban-mobility-tracker/raw/master/notebooks/highway02_frame000010.jpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 预测</span>
</span></span><span style=display:flex><span>!./darknet detect cfg/yolov3-tiny-prn.cfg yolov3-tiny-prn.weights highway02_frame000010.jpg -dont_show
</span></span></code></pre></div><p>结束后会在当前目录，生成一个<code>predictions.jpg</code>，即是标注结果。我们用PIL输出，即可看到标注情况：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> Image
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Image<span style=color:#f92672>.</span>open(<span style=color:#e6db74>&#39;predictions.jpg&#39;</span>)
</span></span></code></pre></div><p><img src=darknet_yolov3-tiny.png alt=效果演示></p><blockquote><p>YOLOv4标注的更多，连远处的车和广告牌都标出来了（虽然识别成了火车，不过看起来确实有点像）</p></blockquote><h2 id=2-自定义物体识别-whill-dataset>2. 自定义物体识别 (whill dataset)</h2><p>为了识别自定义的物体，我们自然要找个没见过的东西和并标注。这里为了简便，我们用<a href=https://github.com/KazumichiShirai/darknet/tree/master/data/whill>KazumichiShirai</a>提供的数据集，100来张自动轮椅的图片进行目标识别。</p><p>效果如下：</p><p><img src=darknet_whill.jpg alt=效果演示></p><p>原版是用 <a href=https://github.com/KazumichiShirai/yolo-detect-custom-objects/blob/master/whill_model_c_yolo.ipynb>darknet53训练</a> 的，这里我们改成用YOLO的预训练权重。</p><p>为简便起见，我已经打包好了这些图片和YOLOv4的训练参数配置。注意不是下载到本地，直接转储到Google Drive的 <code>datastes/whill/</code> 下备用：</p><p><a href="https://drive.google.com/drive/folders/1A6ogns-_aJee3mItRykMy_ZtqzsyOeZu?usp=sharing">https://drive.google.com/drive/folders/1A6ogns-_aJee3mItRykMy_ZtqzsyOeZu?usp=sharing</a></p><h3 id=21-darknet-training-环境准备>2.1 darknet training 环境准备</h3><p>首先参考方法1编译darknet，但训练必须使用GPU，因此我们需要先改下<code>Makefile</code>（最开始就是卡这里，默认非GPU的darknet，到train步骤就报错）。主要变动是头部的几个参数(如果GPU够好，<code>CUDNN_HALF</code>可按实际情况打开)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span>GPU<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>CUDNN<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>CUDNN_HALF<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>OPENCV<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>这里推荐直接用上面提供的数据，其中已经包含了Makefile，我们直接cp过来（注意先要<a href=http://blog.imaou.com/Colab_tricks/?#2-%E8%AE%BF%E9%97%AE-google-drive-%E4%B8%8A%E7%9A%84%E6%95%B0%E6%8D%AE>mount gdrive</a>）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 准备GPU的 darknet 编译文件</span>
</span></span><span style=display:flex><span>!cp -fv <span style=color:#e6db74>&#34;/gdrive/My Drive/datasets/whill/Makefile&#34;</span> Makefile
</span></span><span style=display:flex><span>!make -j8
</span></span></code></pre></div><p>编译成功后，我们将生成的 darknet 复制到 <code>build/darknet/x64/</code> 下，并参考<a href=https://github.com/AlexeyAB/darknet#how-to-train-to-detect-your-custom-objects>官方教程</a>准备whill的配置与数据文件（建议开始仔细看看官方教程的这段，里面对怎么修改参数介绍得很清楚）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>!cp -fv darknet ./build/darknet/x64/
</span></span><span style=display:flex><span>%cd ./build/darknet/x64/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置与权重，yolov3-tiny.conv.11 可以提前转储到gdrive下，然后像这样cp过来（比直接wget快很多）</span>
</span></span><span style=display:flex><span>!test -f yolov3-tiny_whill.cfg <span style=color:#f92672>||</span> cp -fv <span style=color:#e6db74>&#34;/gdrive/My Drive/datasets/whill/yolov3-tiny_whill.cfg&#34;</span> .
</span></span><span style=display:flex><span>!test -f yolov3-tiny.conv.11 <span style=color:#f92672>||</span> cp -v <span style=color:#e6db74>&#34;/gdrive/My Drive/datasets/models/yolov3-tiny.conv.11&#34;</span> .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># whill的数据文件</span>
</span></span><span style=display:flex><span>!test -f data/whill.names <span style=color:#f92672>||</span> cp -fv <span style=color:#e6db74>&#34;/gdrive/My Drive/datasets/whill/whill.names&#34;</span> data/
</span></span><span style=display:flex><span>!test -f data/whill.data <span style=color:#f92672>||</span> cp -fv <span style=color:#e6db74>&#34;/gdrive/My Drive/datasets/whill/whill.data&#34;</span> data/
</span></span><span style=display:flex><span>!test -f data/whill_train.txt <span style=color:#f92672>||</span> cp -fv <span style=color:#e6db74>&#34;/gdrive/My Drive/datasets/whill/train.txt&#34;</span> data/whill_train.txt
</span></span><span style=display:flex><span>!test -f data/whill_test.txt <span style=color:#f92672>||</span> cp -fv <span style=color:#e6db74>&#34;/gdrive/My Drive/datasets/whill/test.txt&#34;</span> data/whill_test.txt
</span></span></code></pre></div><h3 id=22-training>2.2 training</h3><p>以下以 YOLOv3-tiny 为例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 第一次从 yolov3-tiny.conv.11 开始训练</span>
</span></span><span style=display:flex><span>!./darknet detector <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      train -dont_show <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      data/whill.data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      yolov3-tiny_whill.cfg <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      yolov3-tiny.conv.11
</span></span></code></pre></div><p>100轮后会在 backup/yolov3-tiny_whill_last.weights 生成备份。之后可以用这个接着训练，因此每次colab跑完，记得将之cp回gdrive：</p><p>比如: <code>!cp -fv "backup/yolov3-tiny_whill_last.weights" "/gdrive/My Drive/datasets/whill/"</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 接着上次的位置开始训练</span>
</span></span><span style=display:flex><span>!./darknet detector <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      train -dont_show <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      data/whill.data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      yolov3-tiny_whill.cfg <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      backup/yolov3-tiny_whill_last.weights
</span></span></code></pre></div><p>常见问题是启动后报 <code>Out of memory</code>，查了下是 <code>subdivisions</code> 太小导致(官方文档也有说明)，参考下面方法把<code>16</code>改大到<code>32或64</code>即可：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>!cat yolov3-tiny_whill.cfg | grep subdivisions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 增加 subdivisions 避免 Out of memory</span>
</span></span><span style=display:flex><span>!sed -i <span style=color:#e6db74>&#34;s/subdivisions=16/subdivisions=32/&#34;</span> yolov3-tiny_whill.cfg
</span></span></code></pre></div><p>每100轮还会输出一个图片，包含lost的情况，能够比较方便的判断目前进度如何。</p><h3 id=23-detect>2.3 detect</h3><p>对训练好的weights，运行如下test命令即可进行预测。输出结果见<code>predictions.jpg</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>!./darknet detector <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      test -dont_show <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      data/whill.data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      yolov3-tiny_whill.cfg <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      backup/yolov3-tiny_whill_last.weights <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      data/whill/000126.jpg
</span></span></code></pre></div><p>如果没有输出，请将<code>yolov3-tiny_whill.cfg</code>里的<code>batch</code>和<code>subdivisions</code>都改成<code>1</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>!sed -i <span style=color:#e6db74>&#34;s/batch=64/batch=1/&#34;</span> yolov3-tiny_whill.cfg
</span></span><span style=display:flex><span>!sed -i <span style=color:#e6db74>&#34;s/subdivisions=16/subdivisions=1/&#34;</span> yolov3-tiny_whill.cfg
</span></span></code></pre></div></div><div class=post-footer></div></article></main></body></html>